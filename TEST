#!/usr/bin/env bash

# Colour codes for printing
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

# Clear log file
> tests/log.txt

# Iterate over files to test
for source_file in $(ls tests | grep .cog)
do
  binary_file=$(echo $source_file | cut -f 1 -d '.')
  echo "Testing $binary_file..."
  # Compile
  #TODO: use -fsanitize=address when memory leaks are fixed
  ./cognac tests/$source_file -O0 "$@" > /dev/null 2>&1
  # Check if file exists (successful compilation)
  cd tests
  if test -f $binary_file; then
    # Run - outputting to logfile
    echo "PASS: $source_file compiles successfully" >> log.txt
    { ./$binary_file; } 2>>log.txt 1>&2 # Segfaults will also be redirected to logfile
    rm $binary_file
  else
    # File not exists is error
    echo "FAIL: $source_file does not compile!" >> log.txt
  fi
  cd ..
done

# Number of tests failed
while IFS= read -r line;
do
  if [[ ! $line == PASS:* ]]; then
    echo -e "${RED}Some tests failed! See log.txt.${NC}"
    exit
  fi
done < ./tests/log.txt

echo -e "${GREEN}All tests passed!${NC}"
